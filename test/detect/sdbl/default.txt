ВЫБРАТЬ
    Ключи.Ссылка КАК Документ,
    Ключи.Дата КАК ДатаДокумента,
    Ключи.Номер КАК НомерДокумента,
    Ключи.Автор КАК Автор,
    ЕСТЬNULL(Суммы.СуммаДокумента, 0) КАК СуммаДокумента,
    СУММА(Товары.Количество) КАК Количество,
    СРЗНАЧ(Товары.Цена) КАК СредняяЦена,
    МАКСИМУМ(Товары.Цена) КАК МаксимальнаяЦена,
    МИНИМУМ(Товары.Цена) КАК МинимальнаяЦена,
    COUNT(РАЗЛИЧНЫЕ Товары.Номенклатура) КАК РазличныеНоменклатуры,
    CASE
        WHEN Ключи.Дата < ДОБАВИТЬКДАТЕ(ТекущаяДата(), ДЕНЬ, -30) 
            THEN "Старый"
        WHEN Ключи.Автор ЕСТЬ NULL
            THEN "Без автора"
        ELSE "Новый"
    END КАК Категория
ИЗ
    Документ.ЗаказПокупателя КАК Ключи
        ЛЕВОЕ СОЕДИНЕНИЕ
            (ВЫБРАТЬ
                Заказы.Ссылка,
                СУММА(ЗаказыТовары.Сумма) КАК СуммаДокумента
            ИЗ
                Документ.ЗаказПокупателя КАК Заказы
                    ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя.Товары КАК ЗаказыТовары
                    ПО Заказы.Ссылка = ЗаказыТовары.Ссылка
            СГРУППИРОВАТЬ ПО
                Заказы.Ссылка) КАК Суммы
        ПО Ключи.Ссылка = Суммы.Ссылка
        ПРАВОЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя.Товары КАК Товары
        ПО Ключи.Ссылка = Товары.Ссылка

ГДЕ
    Ключи.Дата МЕЖДУ ДОБАВИТЬКДАТЕ(ТекущаяДата(), ДЕНЬ, -90) И ТекущаяДата()
    И Ключи.Проведен = ИСТИНА
    И НЕ Товары.Номенклатура ЕСТЬ NULL
    И Товары.Цена > 0

СГРУППИРОВАТЬ ПО
    Ключи.Ссылка,
    Ключи.Дата,
    Ключи.Номер,
    Ключи.Автор,
    Суммы.СуммаДокумента

ИМЕЮЩИЕ
    СУММА(Товары.Количество) > 10

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ ПЕРВЫЕ 5
    ВозвратТовары.Ссылка,
    ВозвратТовары.Номер,
    ВозвратТовары.Дата,
    "Возврат" КАК Категория
ИЗ
    Документ.ВозвратТоваров КАК ВозвратТовары
УПОРЯДОЧИТЬ ПО
    ДатаДокумента УБЫВ,
    НомерДокумента;
